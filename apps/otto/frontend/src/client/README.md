# `api`

All backend calls are made through the `api` object (exported by `./index.ts`),
by using type inference it should prevent a class of errors caused by calling
non-existent APIs or making ill-formed requests.

The `api` object is used to call two kinds of APIs:

1.  APIs defined in Frappe Framework (using v1)
2.  APIs defined in Flow (using v2)

## API definitions

Frappe Framework APIs are statically defined in `./framework.ts`

Otto APIs are dynamically defined in `./generated.types.ts`, i.e. its types are
generated by using the `bench generate-types` command. The mapping for these are
created like so:

From source API `.py` files defined like:

```python
api/
├── __init__.py
│   ├── def ping() -> Literal["pong"]: ...
│   └── def echo(message: str) -> str: ...
└── example.py
    └── def some_function(message: str) -> str: ...
```

To a TypesScript interface like:

```typescript
export interface API {
  ping(): Call<string>;
  echo(args: { message: string }): Call<string>;
  example: {
    some_function(args: { message: string }): Call<string>;
  };
}
```

## Call object

All API calls return a `Call` object. This is similar to a `Promise` object, i.e
it can be awaited or used with `.then()`, or `.catch()` etc.

The main difference w.r.t a `Promise` is that the `Call` object has additional
properties that are set depending on the state of the request such as `loading`,
`data`, `failed`, etc. For more details check the interface `Call` in
`./types.ts`.

## Modifiers

All API calls can be modified using the `modify` method. This takes a Modifier
(defined `./types.ts`). For example to make use of modifiers like cache the call
will change:

- From `api.func(args)`
- To `api.modify({cache: true}).func(args)`

## Examples

Here're a few calling convention examples:

```typescript
// `echo` is handled under `otto/api/__init__.py`
const call = api.echo({ message: "Hello, World!" }); // Call<string>
const message = await call; // "Hello, World!"

// Using modifiers
const message = await api
  .modify({ cache: true })
  .echo({ message: "Hello, world!" });

// Calling Framework APIs
const doc = await api.get_doc("DocType", "DocName");
```

Available API methods should be shown by the editor using type inference.
Calling anything should result in a TypeScript compile error.
